# 网格世界可视化平台 GridWorld-Visual-Platform

A Platform for GridWorld Visualization



## 1 使用说明

### 基本概念

- 坐标系统
  - 设备坐标系统
    - 沿用Qt默认坐标系统，以**设备左上角**为原点，**从右至左**为X轴正方向，**从上至下**为Y轴正方向。
  - 物理坐标、逻辑坐标
    - 物理坐标系即窗口设备坐标系，以**窗口左上角**为原点，**单位为像素**，X坐标向右增长，Y坐标向下增长。
    - 逻辑坐标系是`GridWorld`采用的基础坐标系，单位为**格**，以每格**左上角所在点**代表整个格子的坐标。
  - 地理坐标及其精度
    - 考虑到未来可能需要对**实际地图**进行可视化比对，`GridWorld`提供了对**经纬度坐标**的简单支持。
    - 默认逻辑坐标原点对应实际地理坐标（39.910°N，116.400°E，**北京天安门**）。
    - 默认**地理坐标精度**（即每单位逻辑坐标对应经纬度大小）为**0.001**（约111米）。

  > 在`GridWorld`中，逻辑坐标（crd）和物理坐标（pos）均以`QPoint`类（整型二维点）表示，地理坐标（geo）以`QPointF`（浮点型二维点）表示，由`LayoutDeputy`负责维护相关数据，并提供逻辑坐标、物理坐标以及地理坐标互相转换的函数。

- 图层绘制

  > 在`GridWorld`3.0 中，图层（`Layers`）是绘图系统的**核心**。`LayerProxy`定义了**图层实现接口**，所有图层均继承自该类。各图层对象负责维护自己绘图所需要的**数据**，定义自己绘图的**具体步骤**，决定自己的**绘图时机**（`on_stage`/`on_paint`）、**覆盖层次**（`level`）和**可见性**（`Visible`）等图层属性。所有自定义图层在**实例化时**会自动与`GridWorld`进行**绑定**，并将自己添加到`RenderDeputy`的**图层列表**之中，由`RenderDeputy`自动完成图层的调度和渲染。

  - 缓冲图层（`on_stage`）
    
  	 > 为提升绘图性能，`RenderDeputy`会将比较**耗时但无需实时更新**的任务绘制到**缓冲图层**之中。缓冲图层仅在`on_stage`阶段更新，可通过`RenderDeputy`调用`mark_need_restage`方法**主动标记更新**。

    - AOI图层
      - Level: -3（最底层）
      - 在`GridWorld`2.0之后，AOI图层以`QPixmap`（**位图**）类型存储AOI信息，其中**每一个像素代表一个逻辑方格**。
    - 在绘制时，AOI图层会借助Qt的**Window-Viewport Mapping（逻辑-物理视窗映射）**机制绘制到缓冲图层上，从而得到较为理想的性能表现。
      - 与AOI绘制有关的**布局信息**（如逻辑偏移、视窗大小等）由`LayutDeputy`负责维护。
      - 可通过调用`reload`/`update`函数**主动更新**AOI图层的数据。
    - 轨迹图层
      - Level: -2
      - 轨迹图层以**有规律的点线**来表示轨迹。
      - 在`GridWorld`2.0之后，轨迹图层以`QPixmap`（**位图**）类型来缓存轨迹绘图信息（每个逻辑方格对应**15x15**个像素）。
      - 轨迹图层以**15:1**的比例的将每一个轨迹缓存到一个**独立**的`trace_map`上，并根据需求动态绘制到设备上。
      - `trace_indexes`指示了轨迹图层在绘制时所需绘制的**轨迹的索引**，并动态管理`trace_map`的集合。
      - 轨迹图层实现了**懒加载**机制以提高性能表现，不在视窗范围内的轨迹不会被绘制。
      - 相关布局信息的维护方式和数据更新方式同上。
    - 包裹图层
      - Level: -1
      - 包裹图层以略小于逻辑方格的**彩色嵌套矩形**来表示包裹。
      - 包裹图层的绘制逻辑类似于轨迹图层，不同的是在`parcels_map`上每**10x10**个像素对应逻辑坐标的一个方格。
    - 栅格图层
      - Level: 1
      - 栅格图层负责在设备（缓冲图层）上绘制相互垂直的线条以划分出网格区域。
      - 栅格类型分为两种：基础栅格和定位栅格。**基础栅格线细而密**，在`GridWorld`进行**缩放或平移**时暂停绘制以提高性能表现；**定位栅格线粗而疏**，在每次更新时均会绘制。
      - 栅格被设定了**最小间距**和**最大间距**，当因缩放而超出间距限制时，栅格图层会自动调整**栅格缩放等级**以适应限制。
      - 栅格缩放等级最小为0级（即每个基础栅格对应一个逻辑方格，再小则没有意义），最大为10级（再大会导致溢出）。
      - 栅格参数由`LayoutDeputy`负责维护，如`level`指示了栅格的缩放等级，而`grid_cov_fac`指示了基础栅格和定位栅格的**换算关系**。
    
  - 实时绘制（`on_paint`）

    > 实时绘制指在窗口**每次重绘时（`on_paint`）均会执行一次绘图步骤**。实时绘制的绘图设备不再是缓冲图层而是**窗口设备**。在进行图层的实时绘制前，`RenderDeputy`总会先将缓冲图层绘制到窗口上，这意味着缓冲图层上的内容总会被实时绘制的内容**覆盖**。

    - 刻度图层
      - Level: 2
      - 刻度图层负责计算每条**定位栅格线**所对应的逻辑坐标和地理坐标，并将其绘制在设备上。
      - 图层实例属性`enable_crd_mark`指示了是否标记逻辑坐标，类似的，`enable_geo_mark`指示了是否绘制地理坐标。
    - 聚焦图层
      - Level: 3
      - `StateDeputy`记录了鼠标的实时操作信息，并将其**经过或划定**的区域分别解读为聚焦点`focus_point`和聚焦框`focus_rect`，聚焦图层则负责将这些信息绘制在设备上。
    - 提示信息
      - Level: inf（最顶层）
      - 提示信息的绘制并不是基于图层实现的。它由`TooltipProxy`负责管理，并由`RenderDeputy`在所有图层绘制完成之后绘制在窗口上，因此可视为一个永远位于最顶层的虚拟图层。

### 代码启动

- 创建GridWorld

```python
app = QApplication([]) # Qt应用启动函数，应在启动前调用
world = GridWorld() # 创建GridWorld实例
```

- 配置GridWorld

> GridWorld配置阶段可以进行一些简单的设置。可以通过GridWorld实例来获取其中的代理对象或图层对象。

```python
world.data_deputy.read_aoi("./data/aoi/AOI_20_grid.npy")
world.aoi_layer.reload()

world.data_deputy.read_aoi("./data/images/2.jpg")
world.data_deputy.read_traces("./data/trace/trace_1.npy")
world.data_deputy.read_parcels("./data/parcels/parcels_n.npy")

indexes = range(10)
world.trace_layer.set_indexes(indexes)
world.parcel_layer.set_indexes(indexes)
```

- 创建异步任务
>GridWorld启动后会进入**事件循环**，以保证能时刻对用户输入做出反应。任何在主线程进行的耗时任务均会造成**线程阻塞**，进而导致可视化**窗口卡死**。因此，必须开启子线程来**同步处理**其他计算任务。GridWorld2.0对多线程提供了简单的支持。在GridWorld3.0中，`AsyncProxy`提供了更为方便、强大的支持。

  - 添加信号和槽
  - 动态申请线程
  - 动态送回数据
- 进入事件循环
- 展示

```python
app = QApplication([])
grid_world = GridWorld()

world_config(grid_world)

grid_world.show()
sys.exit(app.exec())
```



### 基本操作

- - 
- 鼠标操作
- 图层核心
  - 内置图层
  - 智能图层



## 2 代码架构

### 2.1 网格世界代理 GridWorld Deputy

> Deputy，有副手、代理之意，其负责管理GridWorld的部分数据，代理部分操作，作为**单例对象**依附于**GridWrold**而存在，是GridWorld的专属组成部分，不可在项目的其他地方创建新实例。

#### 2.1.1 数据代理 `DataDeputy`

#### 2.1.2 状态代理 `StateDeputy`

#### 2.1.3 布局代理 `LayoutDeputy`

#### 2.1.4 渲染代理 `RenderDeputy`

#### 2.1.5 菜单代理 `MenuDeputy`

----

### 2.2 全局代理 GlobalProxy

> Proxy，指受托人、代表，在本项目中作为一种**连接层单元**而存在，可**全局访问**并**创建实例**，全局代理可以简化某些工具的使用流程，提高工作效率。

#### 2.2.1 图层代理 `LayerProxy`

> 本质是图层定义接口。

#### 2.2.2 异步代理 `AsyncProxy`

> 本质是线程池。

#### 2.2.3 数据代理 `DataProxy`

> 负责集中管理某一类数据。

#### 2.2.4 提示代理 `TooltipProxy`

> 负责集中管理提示集合。



----

### 2.3 辅助工具 Utils

#### 2.3.1 三阶曲线集合 `BezierCurves`

#### 2.3.2 色彩管理工具 `ColorSet`

#### 2.3.3 文本提示工具 `Tooltip`

#### 2.3.4 性能测算工具 `XPSChecker`

#### 2.3.5 二维处理函数库 `Custom2D`



----

### 2.4 图层定义 Layers

#### 2.4.1 内置图层 Built-in Layers

#### 2.4.2 智能图层 Auto Layers

#### 2.4.3 自定义图层  CustomLayers



## 3 更新日志

- 1.0 架构初步搭建
  - 实现网格
  - 初步搭建坐标体系
    - Level坐标
- 2.0 缓存映射更新
  - 缓存机制
  - 全新的布局更新算法
    - 基于物理-逻辑映射
    - 新的坐标转换体系
      - 逻辑坐标、物理坐标、地理坐标
  - 全新绘制算法
    - 全新AOI绘制算法
      - 基于位图映射
    - 全新轨迹、包裹绘制算法
  - 懒加载算法
  - 初步异步支持
- 3.0 图层异步更新（pre）
  - 图层核心
    - 支持自定义图层
    - 智能图层
  - 异步代理
  - 中键操作
- 4.0 设想
  - 信息增强
  - 中断与历史

